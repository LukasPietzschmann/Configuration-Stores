\ProvidesPackage{pdfpc}

\RequirePackage{kvoptions}
\RequirePackage{xstring}
\RequirePackage{iftex}
\RequirePackage{hyperxmp}
\ifLuaTeX
	\RequirePackage{stringenc}
	\RequirePackage{pdftexcmds}
\fi

\SetupKeyvalOptions{family=PDFPC, prefix=PDFPC@}

\DeclareStringOption{duration}
\DeclareStringOption{starttime}
\DeclareStringOption{endtime}
\DeclareStringOption{enduserslide}
\DeclareStringOption{lastminutes}
\DeclareBoolOption{hidenotes}
\DeclareBoolOption{overridenote}
\DeclareStringOption{notesposition}
\DeclareBoolOption[false]{disablemarkdown}
\DeclareStringOption{defaulttransition}
\DeclareDefaultOption{\@unknownoptionerror}

\ProcessKeyvalOptions*

\ifx\PDFPC@duration\@empty
\else
	\IfInteger{\PDFPC@duration}{}
	{\PackageWarningNoLine{pdfpc}{`duration' should be an integer}}%
\fi

\ifx\PDFPC@enduserslide\@empty
\else
	\IfInteger{\PDFPC@enduserslide}{}
	{\PackageWarningNoLine{pdfpc}{`enduserslide' should be an integer}}%
\fi

\ifx\PDFPC@lastminutes\@empty
\else
	\IfInteger{\PDFPC@lastminutes}{}
	{\PackageWarningNoLine{pdfpc}{`lastminutes' should be an integer}}%
\fi

\ifPDFPC@overridenote
	\renewcommand<>{\note}[2][]{%
		\IfStrEq{#1}{item}%
		% Imitate a bullet
		{\pdfpcnote#3{* #2}}%
		{\pdfpcnote#3{#2}}%
	}%
\fi

\def\pdfpc@notespositionauto{auto}%
\ifx\PDFPC@notesposition\@empty%
	\def\PDFPC@notesposition{auto}%
\fi%

\def\pdfpcsetup{\kvsetkeys{PDFPC}}%
\ifx\PDFPC@notesposition\pdfpc@notespositionauto%
	\def\PDFPC@notesposition{none}%
	\def\pdfpc@onepaperheight{\paperheight}%
	\def\pdfpc@twopaperheight{2\paperheight}%
	\def\pdfpc@onepaperwidth{\paperwidth}%
	\def\pdfpc@twopaperwidth{2\paperwidth}%
	\def\pdfpc@pagecenter{\pgfpoint{.5\paperwidth}{.5\paperheight}}%

	\ifx\pgfpageoptiontwoheight\pdfpc@onepaperheight%
		\ifx\pgfpageoptiontwowidth\pdfpc@twopaperwidth%
			\ifx\pgfpageoptionfirstcenter\pdfpc@pagecenter%
				\def\PDFPC@notesposition{right}%
			\else%
				\def\PDFPC@notesposition{left}%
			\fi%
		\fi%
	\fi%
	\ifx\pgfpageoptiontwoheight\pdfpc@twopaperheight%
		\ifx\pgfpageoptiontwowidth\pdfpc@onepaperwidth%
			\ifx\pgfpageoptionfirstcenter\pdfpc@pagecenter%
				\def\PDFPC@notesposition{top}%
			\else%
				\def\PDFPC@notesposition{bottom}%
			\fi%
		\fi%
	\fi%
\fi%

\newcommand*{\pdfpc@schema}{%
	\hyxmp@add@to@xml{%
		______<rdf:Description xmlns:pdfpc="https://github.com/pdfpc/pdfpc">^^J%
	}%
	\hyxmp@add@simple{pdfpc:Duration}{\PDFPC@duration}%
	\hyxmp@add@simple{pdfpc:StartTime}{\PDFPC@starttime}%
	\hyxmp@add@simple{pdfpc:EndTime}{\PDFPC@endtime}%
	\hyxmp@add@simple{pdfpc:EndUserSlide}{\PDFPC@enduserslide}%
	\hyxmp@add@simple{pdfpc:LastMinutes}{\PDFPC@lastminutes}%
	\hyxmp@add@simple{pdfpc:NotesPosition}{\PDFPC@notesposition}%
	\ifPDFPC@disablemarkdown%
		\hyxmp@add@simple{pdfpc:DisableMarkdown}{true}%
	\else%
		\hyxmp@add@simple{pdfpc:DisableMarkdown}{false}%
	\fi
	\hyxmp@add@simple{pdfpc:DefaultTransition}{\PDFPC@defaulttransition}%
	\hyxmp@add@to@xml{%
		______</rdf:Description>^^J%
	}%
}

\let\oldhyxmp@pdf@schema\hyxmp@pdf@schema
\renewcommand{\hyxmp@pdf@schema}{{\oldhyxmp@pdf@schema}{\pdfpc@schema}}

\ifPDFPC@hidenotes%
	\newcommand<>{\pdfpcnote}[1]{}%
\else%
	\ifXeTeX%
		\newcommand<>{\pdfpcnote}[1]{%
		\only#2{%
		\edef\\{\string\n}%
		\special{pdf: ann width 0pt height 0pt depth 0pt%
			<<%
			/Subtype /Text%
			/Contents (#1)%
			/F 6%
			>>%
		}%
		}%
		\relax%
		}%
	\else%
		\ifLuaTeX%
			\protected\def\pdfannot {\pdfextension annot }%
			\newcommand<>{\pdfpcnote}[1]{%
			\only#2{%
			\edef\tmp@a{\pdf@escapehexnative{#1}}
			\expandafter\SE@ConvertFrom\expandafter\tmp@a\expandafter{\tmp@a}{utf8}
			{%
			\edef\\{\string\n}%
			\pdfannot width 0pt height 0pt depth 0pt {%
					/Subtype /Text%
					/Contents <FEFF\tmp@a>%
					/F 6%
				}%
			}%
			}%
			\relax%
			}%
		\else%
			\newcommand<>{\pdfpcnote}[1]{%
			\only#2{%
			\edef\\{\string\n}%
			\pdfannot width 0pt height 0pt depth 0pt {%
					/Subtype /Text%
					/Contents (#1)%
					/F 6%
				}%
			}%
			\relax%
			}%
		\fi%
	\fi%
\fi%
\newcommand<>{\talknote}[1]{\only#2{\pdfpcnote{- #1}\relax}}
