

% Consul Architecture
% Pretty Good: http://man.hubwiz.com/docset/Consul.docset/Contents/Resources/Documents/docs/internals/architecture.html
% [Consul Architecture](https://developer.hashicorp.com/consul/docs/architecture)
% [Consul Vocabulary](https://developer.hashicorp.com/consul/docs/install/glossary)
% [Consensus Protocol](https://developer.hashicorp.com/consul/docs/architecture/consensus)
% **Fokus: [KVStore](https://developer.hashicorp.com/consul/docs/dynamic-app-config/kv)**
% - 


\begin{frame}
	\frametitle{Consul}
	\framesubtitle{Overview}
\end{frame}

\begin{frame}[shrink]
	\frametitle{Consul}
	\framesubtitle{Terminology \& Architecture}
	\begin{columns}[T]
		\begin{column}{0.7\textwidth}
			\includegraphics{assets/consul_architecture.png}
		\end{column}
		% \begin{column}{0.3\textwidth}
		% 	\begin{itemize}
		% 		\item Datacenter
		% 		\item Agent \begin{itemize}
		% 			\item Client
		% 			\item Server
		% 		\end{itemize}
		% 	\end{itemize}
		% \end{column}
	\end{columns}
	% Agent (Server/Client), Datacenters
	% Clients are Stateless and Forward RPC calls to Server Agents
	% Servers participate in Raft Quorum. Thus, they save cluster state (like KV keys)
\end{frame}

\begin{frame}
	\frametitle{Consul}
	\framesubtitle{Communication}
	% Two Types: Raft for Consensus, Serf for Gossip
	\begin{columns}[b]
		\begin{column}{0.5\textwidth}
			\emph{Raft} (Consensus)
			\begin{itemize}
				\item test123
			\end{itemize}
		\end{column}
		\begin{column}{0.5\textwidth}
			\emph{Surf} (Gossip)
			\begin{itemize}
				\item test123
			\end{itemize}
		\end{column}
	\end{columns}
\end{frame}

\begin{frame}
	\frametitle{Consul}
	\framesubtitle{Raft Consensus}
	\begin{tikzpicture}[remember picture,overlay]
		\node[xshift=-1.5cm,yshift=-1.5cm](logo) at (current page.north east){%
		\includegraphics[width=3cm]{assets/raft_logo.pdf}};
		\node[draw=none,yshift=0.5cm,text width=3cm] at (logo.south) {\baselineskip=1pt\tiny\url{commons.wikimedia.org/w/index.php?curid=105476108}\par};
	\end{tikzpicture}

	\begin{itemize}
		\item Consensus algorithm for state machine replication
		\item Not Byzantine Fault Tolerant (leader is trusted)
		\item 5 Nodes for 1 Crash, 7 for 2 Crash Tolerance
	\end{itemize}
	% Logo Credits: 
\end{frame}

\begin{frame}
		\frametitle{Consul}
		\framesubtitle{Consistency}

		\emph{Writes} to the replicated log go through Raft

		Three consistency modes for \emph{reads}:
		\begin{description}
			\item[default] Use of \emph{leader leasing}: time window where the leader assumes that they are still the leader (risk of partitioning and 2 concurrent leaders $\Rightarrow$ stale reads)
			\item[consistent] Before responding, the leader has to verify with a quorum of nodes that they are still the leader
			\item[stale] Any server agent (leader \& follower) can respond
		\end{description}
		%\textcite[Consensus Protocol]{ConsulDoc}
\end{frame}

\begin{frame}[fragile]
	\frametitle{Consul}
	\framesubtitle{KV - Usage}

	\begin{columns}[t]
		\begin{column}{0.45\textwidth}
			\begin{minted}{bash}
$ consul agent -dev

# other terminal:
$ consul kv put my/key 123
$ consul kv get my/key
123
			\end{minted}
		\end{column}
		\begin{column}{0.55\textwidth}
			CLI or HTTP API

			Responses contain metadata like last writer, ...
			% Metadata response: https://developer.hashicorp.com/consul/api-docs/kv#metadata-response
		\end{column}
	\end{columns}
\end{frame}

\begin{frame}[fragile]
	\frametitle{Consul}
	\framesubtitle{KV - Long Polling}
	\begin{minted}{bash}
$ curl -v http://localhost:8500/v1/kv/my/key
# ...
< X-Consul-Index: 19
# ...

$ curl -v http://localhost:8500/v1/kv/my/key?index=19
# blocks until value is changed or timeout is reached
# (max. 10 minutes)
	\end{minted}
\end{frame}
